(window.webpackJsonp=window.webpackJsonp||[]).push([[349],{622:function(s,n,t){"use strict";t.r(n);var a=t(14),e=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[n("strong",[s._v("可靠消息最终一致性事务")])]),s._v(" "),n("p",[s._v("当事务发起方执行完全本地事务后并发出一条消息，事务参与方（消息消费者）一定能够接收消息并处理事务成功")]),s._v(" "),n("p",[s._v("需要依靠消息中间件完成")]),s._v(" "),n("p",[n("strong",[s._v("可靠消息最终一致性方案要解决以下几个问题：")])]),s._v(" "),n("p",[s._v("<1>本地事务与消息发送的原子性问题(核心问题)")]),s._v(" "),n("p",[s._v("事务发起方在本地事务执行成功后消息必须发出去，执行失败则不发送消息。")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v("；\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.数据库操作")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.发送MQ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),s._v(" transation；\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("如果发送 MQ 消息失败，就会抛出异常，导致数据库事务回滚。但如果发送 MQ 消息是超时异常，数据库回滚，但 MQ 其实已经正常发送来，会导致数据不一致。")]),s._v(" "),n("p",[s._v("解决方案："),n("strong",[s._v("本地消息表")])]),s._v(" "),n("p",[s._v("方案的核心是通过本地事务保证数据业务操作和消息的一致性，然后通过定时任务将消息发送至消息中间件，待确认消息发送给消费方成功再将消息删除。")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v("；\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.数据库操作")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.本地消息表记录为 未发送")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),s._v(" transation；\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3.发送MQ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4.修改本地消息表记录为 已发送")]),s._v("\n\ncrontab:\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 5.轮训 本地消息表，检查消息状态，未发送消息进行重试")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);