(window.webpackJsonp=window.webpackJsonp||[]).push([[364],{638:function(s,t,a){"use strict";a.r(t);var n=a(14),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"基于-redis-和号段模式的分布式-id-实现方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于-redis-和号段模式的分布式-id-实现方案"}},[s._v("#")]),s._v(" 基于 Redis 和号段模式的分布式 id 实现方案")]),s._v(" "),t("p",[s._v("利用 redis 原子性和号段模式的高性能实现的分布式 id 方案")]),s._v(" "),t("h3",{attrs:{id:"思维导图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#思维导图"}},[s._v("#")]),s._v(" 思维导图")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://muyids.oss-cn-beijing.aliyuncs.com/%E5%A4%96%E7%A0%94ID%E6%9C%8D%E5%8A%A1.png",alt:"外研ID服务"}})]),s._v(" "),t("h3",{attrs:{id:"场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[s._v("#")]),s._v(" 场景")]),s._v(" "),t("p",[s._v("对外提供全局独立唯一 ID")]),s._v(" "),t("ul",[t("li",[s._v("支持单个、批量不同数量的 ID 获取")]),s._v(" "),t("li",[s._v("支持单调递增、趋势递增不同特性的 ID 获取")])]),s._v(" "),t("h3",{attrs:{id:"业务流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#业务流程"}},[s._v("#")]),s._v(" 业务流程")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://muyids.oss-cn-beijing.aliyuncs.com/id-only_flowchart.png",alt:"业务流程图"}})]),s._v(" "),t("h3",{attrs:{id:"核心服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#核心服务"}},[s._v("#")]),s._v(" 核心服务")]),s._v(" "),t("ol",[t("li",[s._v("id 发号器")]),s._v(" "),t("li",[s._v("id 池定时轮询器")])]),s._v(" "),t("h3",{attrs:{id:"存储设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#存储设计"}},[s._v("#")]),s._v(" 存储设计")]),s._v(" "),t("p",[s._v("应用配置存储（支持高性能查询）+ 缓存 id 池（支持高性能读取、写入）")]),s._v(" "),t("h4",{attrs:{id:"应用配置存储设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#应用配置存储设计"}},[s._v("#")]),s._v(" 应用配置存储设计")]),s._v(" "),t("p",[s._v("mysql 存储 + redis 缓存优化读取性能，注意 数据一致性")]),s._v(" "),t("h4",{attrs:{id:"缓存-id-池设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#缓存-id-池设计"}},[s._v("#")]),s._v(" 缓存 id 池设计")]),s._v(" "),t("p",[s._v("id 池要实现高性能读取和写入，我们选择了 redis 作为底层数据存储")]),s._v(" "),t("p",[s._v("对于数据结构选择，redis 常用容器类型有 hash、list、set、zset，选择哪一个更为合适呢")]),s._v(" "),t("p",[s._v("考虑到要支持"),t("strong",[s._v("单调递增模式")]),s._v("，严格要求顺序性，list 和 zset 都能实现顺序性，究竟该选择哪一个？")]),s._v(" "),t("p",[s._v("我们知道 zset 可以根据权值实现顺序性，但是其底层实现为跳表，其查询、插入、删除的时间复杂度为 O(logn)，不满足我们对高性能的要求，故选择 list")]),s._v(" "),t("h5",{attrs:{id:"发号策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发号策略"}},[s._v("#")]),s._v(" 发号策略")]),s._v(" "),t("p",[s._v("list 中维护了从小到大的预生成 ID 队列，遵循"),t("code",[s._v("FIFO")]),s._v("规则，不管是单个还是批量，直接从队头获取")]),s._v(" "),t("h5",{attrs:{id:"更新策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更新策略"}},[s._v("#")]),s._v(" 更新策略")]),s._v(" "),t("p",[s._v("我们使用"),t("strong",[s._v("号段模式")]),s._v("作为 id 的生成方式，每次从 currentOffset 算法生成 满足 单调递增 or 趋势递增的 ID 序列，执行入队操作")]),s._v(" "),t("ul",[t("li",[s._v("单调递增：不定增率，有序入队")]),s._v(" "),t("li",[s._v("趋势递增：增率为 1，shuffle 后入队\n入队操作完成后，同步更新缓存配置，再异步更新 db 配置")])]),s._v(" "),t("h5",{attrs:{id:"问题思考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题思考"}},[s._v("#")]),s._v(" 问题思考")]),s._v(" "),t("p",[t("strong",[s._v("分布式场景下，缓存 id 池的写入操作，会不会造成重复发号、id 池溢出等问题？")])]),s._v(" "),t("p",[s._v("必须配置"),t("strong",[s._v("分布式锁机制")]),s._v("，保证全局串行化，即某一时刻，只允许一个 ID 生成器的 worker 在工作")]),s._v(" "),t("p",[t("strong",[s._v("批量获取数量大于缓存池大小（缓存池被过度消费），如何处理？")])]),s._v(" "),t("ol",[t("li",[s._v("理论上不会出现这种情况\n"),t("ol",[t("li",[s._v("系统预留 1 分钟的最大秒并发数（目前默认 5000），")]),s._v(" "),t("li",[s._v("定时任务每隔 100ms 扫描，低于最大池的 80%，进行补充")])])]),s._v(" "),t("li",[s._v("如果异常发生，返回空；同时应触发"),t("strong",[s._v("报警机制")])])]),s._v(" "),t("h3",{attrs:{id:"数据库设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库设计"}},[s._v("#")]),s._v(" 数据库设计")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("application"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AUTO_INCREMENT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("update_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("datetime")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'修改时间'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("create_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("datetime")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'创建时间'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("deleted_at"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("bigint")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'删除时间（0:有效）'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("entity_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'实体标识的唯一key'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("entity_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'实体名称描述'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("increasing_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'递增类型(1:单调递增;2:严格递增) 默认为:1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("start_offset"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("bigint")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'初始化的id起始位置'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("step"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1000'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'每次向id池子增加的数量'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("current_offset"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("bigint")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id的当前位置'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("max_size_per_times"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'一次最大获取id量'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("max_size_per_second"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1s最大获取量(秒级并发QPS)'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("min_size_percent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'触发添加的百分比上限'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'循环添加间隔时间ms（不可修改)'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("max_pool_size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id池的最大id存量（系统默认是maxSizePerSecond的300倍，为了保证5分钟不断供）'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNIQUE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("entity_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("entity_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("InnoDB")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AUTO_INCREMENT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARSET")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("初始化实体")]),s._v(" "),t("p",[s._v("比如 user 实体")]),s._v(" "),t("p",[s._v("start_offset : 100000 // id 从 100000 开始\nstep : 1000 // 每次向 id 池子增加 1000 个\ncurrent_offset : // id 的当前位置\nmax_size_per_times : // 一次最大获取 id 量 : 防止 id 获取\nmax_size_per_second : // 1s 最大获取量(秒级并发 QPS)；防止恶意请求")]),s._v(" "),t("p",[s._v("当前 id 池中 id 的库存数量 少于 max_pool_size * min_size_percent / 100 时，向 id 池中增加 step 个 id")]),s._v(" "),t("p",[s._v("max_pool_size * (1-min_size_percent / 100) 应满足 大于等于 step")]),s._v(" "),t("h4",{attrs:{id:"应用表示"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#应用表示"}},[s._v("#")]),s._v(" 应用表示")]),s._v(" "),t("ul",[t("li",[s._v("appKey：应用的唯一 key")]),s._v(" "),t("li",[s._v("appSecret：应用秘钥")]),s._v(" "),t("li",[s._v("appName：应用名称")])]),s._v(" "),t("h4",{attrs:{id:"id-的增长方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#id-的增长方式"}},[s._v("#")]),s._v(" ID 的增长方式")]),s._v(" "),t("ul",[t("li",[s._v("趋势递增 trend")]),s._v(" "),t("li",[s._v("严格递增(单调递增) monotony")])]),s._v(" "),t("h4",{attrs:{id:"id-的分配范围配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#id-的分配范围配置"}},[s._v("#")]),s._v(" ID 的分配范围配置")]),s._v(" "),t("ul",[t("li",[s._v("startOffset 初始化的 id 起始位置")]),s._v(" "),t("li",[s._v("step 每次向 id 池子增加的数量")]),s._v(" "),t("li",[s._v("currentOffset id 的当前位置")])]),s._v(" "),t("h4",{attrs:{id:"缓存-id-池配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#缓存-id-池配置"}},[s._v("#")]),s._v(" 缓存 ID 池配置")]),s._v(" "),t("ul",[t("li",[s._v("maxSizePerTimes 一次最大获取 id 量(默认 1000)")]),s._v(" "),t("li",[s._v("maxSizePerSecond 1s 最大获取量(秒级并发 QPS，默认 5000)")]),s._v(" "),t("li",[s._v("minSizePercent 触发添加的百分比上限（默认 80%）")]),s._v(" "),t("li",[s._v("interval 循环添加间隔时间 10ms（不可修改)")]),s._v(" "),t("li",[s._v("maxPoolSize id 池的最大 id 存量（系统默认是"),t("code",[s._v("maxSizePerSecond")]),s._v("的"),t("code",[s._v("60")]),s._v("倍，为了保证"),t("code",[s._v("1分钟")]),s._v("不断供）")])]),s._v(" "),t("h3",{attrs:{id:"我们做到了"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#我们做到了"}},[s._v("#")]),s._v(" 我们做到了")]),s._v(" "),t("ul",[t("li",[s._v("一致性，服务端保证不会获取到重复的 ID")]),s._v(" "),t("li",[s._v("两种递增方式支持，趋势递增+严格递增")]),s._v(" "),t("li",[s._v("高可用，短 ID 服务允许部署多套完全独立的环境，每个环境产生的 ID 都不一样，client 可以 failover 到任何环境")]),s._v(" "),t("li",[s._v("高性能，每秒钟可以获取百万级的 ID，并且不会出现阻塞")]),s._v(" "),t("li",[s._v("基于时间的大致有序，基本上获取到的 ID 会越来越大，无法保证严格有序，比如一小时前获取的 ID 应该会比一小时后的小")])]),s._v(" "),t("h3",{attrs:{id:"我们不支持"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#我们不支持"}},[s._v("#")]),s._v(" 我们不支持")]),s._v(" "),t("ul",[t("li",[s._v("没有实现严格自增长 ID")]),s._v(" "),t("li",[s._v("无法保证每个 ID 都不浪费")])])])}),[],!1,null,null,null);t.default=e.exports}}]);