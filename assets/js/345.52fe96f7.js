(window.webpackJsonp=window.webpackJsonp||[]).push([[345],{619:function(s,t,a){"use strict";a.r(t);var n=a(14),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("本文参考"),t("a",{attrs:{href:"https://github.com/alibaba/Sentinel/wiki/%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8-Sentinel",target:"_blank",rel:"noopener noreferrer"}},[s._v("在生产环境中使用 Sentinel"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("strong",[s._v("规则推送的三种模式")])]),s._v(" "),t("h5",{attrs:{id:"一、原始模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、原始模式"}},[s._v("#")]),s._v(" 一、原始模式")]),s._v(" "),t("ul",[t("li",[s._v("API 将规则推送至客户端并直接更新到内存中")]),s._v(" "),t("li",[s._v("扩展写数据源（"),t("a",{attrs:{href:"https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95",target:"_blank",rel:"noopener noreferrer"}},[t("code",[s._v("WritableDataSource")]),t("OutboundLink")],1),s._v("）")]),s._v(" "),t("li",[s._v("重启消失")])]),s._v(" "),t("h5",{attrs:{id:"二、pull-模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、pull-模式"}},[s._v("#")]),s._v(" 二、Pull 模式")]),s._v(" "),t("ul",[t("li",[s._v("客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是 RDBMS、文件 等")]),s._v(" "),t("li",[s._v("扩展写数据源（"),t("a",{attrs:{href:"https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95",target:"_blank",rel:"noopener noreferrer"}},[t("code",[s._v("WritableDataSource")]),t("OutboundLink")],1),s._v("）")]),s._v(" "),t("li",[s._v("规则持久化，不保证一致性，不保证高可用")])]),s._v(" "),t("h5",{attrs:{id:"三、push-模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、push-模式"}},[s._v("#")]),s._v(" 三、Push 模式")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("规则中心统一推送")]),s._v("，客户端通过注册监听器的方式时刻监听变化，比如使用 Nacos、Zookeeper 等配置中心")]),s._v(" "),t("li",[s._v("扩展读数据源（"),t("a",{attrs:{href:"https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95",target:"_blank",rel:"noopener noreferrer"}},[t("code",[s._v("ReadableDataSource")]),t("OutboundLink")],1),s._v("）")]),s._v(" "),t("li",[t("strong",[s._v("生产环境下一般采用 push 模式的数据源")])])]),s._v(" "),t("p",[t("strong",[s._v("配置 Nacos 动态数据源")])]),s._v(" "),t("p",[s._v("application.yml")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("application")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" stock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sentinel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("transport")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8719")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dashboard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("datasource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nacos")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server-addr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8848")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dataId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("spring.application.name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sentinel\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DEFAULT_GROUP\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rule-type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flow\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("nacos 控制台增加配置 dataId: stock-service-sentinel，groupId: DEFAULT_GROUP；配置格式选 json")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"resource"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"StockReduce"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"limitApp"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"grade"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"count"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"stategy"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"controlBehavior"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"clusterMode"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("配置规则是一个数组类型，数组中的每个对象是针对每一个保护资源的配置对象，每个对象中的属性解释如下：")]),s._v(" "),t("ul",[t("li",[s._v("resource：资源名，即限流规则的作用对象")]),s._v(" "),t("li",[s._v("limitApp：流控针对的调用来源，若为 default 则不区分调用来源")]),s._v(" "),t("li",[s._v("grade：限流阈值类型（QPS 或并发线程数）；"),t("code",[s._v("0")]),s._v("代表根据并发数量来限流，"),t("code",[s._v("1")]),s._v("代表根据 QPS 来进行流量控制")]),s._v(" "),t("li",[s._v("count：限流阈值")]),s._v(" "),t("li",[s._v("strategy：调用关系限流策略")]),s._v(" "),t("li",[s._v("controlBehavior：流量控制效果（直接拒绝、Warm Up、匀速排队）")]),s._v(" "),t("li",[s._v("clusterMode：是否为集群模式")])]),s._v(" "),t("p",[s._v("启动应用后，请求流控资源的访问 url，正常的话可以在 sentinel 控制台中的流控规则中找到配置的流控规则")]),s._v(" "),t("p",[s._v("需要注意的是当前版本的 Sentinel 控制台不具备同步修改 Nacos 配置的能力，而 Nacos 由于可以通过在客户端中使用 Listener 来实现自动更新。所以，在整合了 Nacos 做规则存储之后，需要知道在下面两个地方修改存在不同的效果：")]),s._v(" "),t("ul",[t("li",[s._v("Sentinel 控制台中修改规则：仅存在于服务的内存中，不会修改 Nacos 中的配置值，重启后恢复原来的值。")]),s._v(" "),t("li",[s._v("Nacos 控制台中修改规则：服务的内存中规则会更新，Nacos 中持久化规则也会更新，重启后依然存在。")])])])}),[],!1,null,null,null);t.default=e.exports}}]);