(window.webpackJsonp=window.webpackJsonp||[]).push([[220],{494:function(s,t,a){"use strict";a.r(t);var r=a(14),n=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"hystrix-服务降级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hystrix-服务降级"}},[s._v("#")]),s._v(" Hystrix 服务降级")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%842.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%843.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%844.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"hystrix-中的重要概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hystrix-中的重要概念"}},[s._v("#")]),s._v(" hystrix 中的重要概念")]),s._v(" "),t("h4",{attrs:{id:"_1-服务降级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-服务降级"}},[s._v("#")]),s._v(" 1,服务降级")]),s._v(" "),t("p",[t("strong",[s._v("比如当某个服务繁忙,不能让客户端的请求一直等待,应该立刻返回给客户端一个备选方案")])]),s._v(" "),t("h4",{attrs:{id:"_2-服务熔断"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-服务熔断"}},[s._v("#")]),s._v(" 2,服务熔断")]),s._v(" "),t("p",[t("strong",[s._v("当某个服务出现问题,卡死了,不能让用户一直等待,需要关闭所有对此服务的访问")])]),s._v(" "),t("p",[t("strong",[s._v("然后调用服务降级")])]),s._v(" "),t("h4",{attrs:{id:"_3-服务限流"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-服务限流"}},[s._v("#")]),s._v(" 3,服务限流")]),s._v(" "),t("p",[t("strong",[s._v("限流,比如秒杀场景,不能访问用户瞬间都访问服务器,限制一次只可以有多少请求")])]),s._v(" "),t("h3",{attrs:{id:"使用-hystrix-服务降级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-hystrix-服务降级"}},[s._v("#")]),s._v(" 使用 hystrix,服务降级:")]),s._v(" "),t("h4",{attrs:{id:"_1-创建带降级机制的-pay-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建带降级机制的-pay-模块"}},[s._v("#")]),s._v(" 1,创建带降级机制的 pay 模块 :")]),s._v(" "),t("p",[s._v("名字: cloud-hystrix-pay-8007")]),s._v(" "),t("h5",{attrs:{id:"_2-pom-文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-pom-文件"}},[s._v("#")]),s._v(" 2,pom 文件")]),s._v(" "),t("h5",{attrs:{id:"_3-配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置文件"}},[s._v("#")]),s._v(" 3,配置文件")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%845.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_4-主启动类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-主启动类"}},[s._v("#")]),s._v(" 4,主启动类")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%848.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_5-service"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-service"}},[s._v("#")]),s._v(" 5,service")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%846.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_6controller"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6controller"}},[s._v("#")]),s._v(" 6controller")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%847.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_7-先测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-先测试"}},[s._v("#")]),s._v(" 7,先测试:")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("此时使用压测工具"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("并发"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20000")]),s._v("个请求"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("请求会延迟的那个方法"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t压测中"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("发现"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("另外一个方法并没有被压测"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("但是我们访问它时"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("却需要等待\n\t\t这就是因为被压测的方法它占用了服务器大部分资源"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("导致其他请求也变慢了\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h5",{attrs:{id:"_8-先不加入-hystrix"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-先不加入-hystrix"}},[s._v("#")]),s._v(" 8,先不加入 hystrix")]),s._v(" "),t("h4",{attrs:{id:"_2-创建带降级的-order-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建带降级的-order-模块"}},[s._v("#")]),s._v(" 2,创建带降级的 order 模块:")]),s._v(" "),t("h5",{attrs:{id:"_1-名字-cloud-hystrix-order-80"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-名字-cloud-hystrix-order-80"}},[s._v("#")]),s._v(" 1,名字: cloud-hystrix-order-80")]),s._v(" "),t("h5",{attrs:{id:"_2-pom"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-pom"}},[s._v("#")]),s._v(" 2,pom")]),s._v(" "),t("h5",{attrs:{id:"_3-配置文件-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置文件-2"}},[s._v("#")]),s._v(" 3,配置文件")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%849.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_4-主启动类-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-主启动类-2"}},[s._v("#")]),s._v(" 4,主启动类")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8411.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_5-远程调用-pay-模块的接口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-远程调用-pay-模块的接口"}},[s._v("#")]),s._v(" 5,远程调用 pay 模块的接口:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8412.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_6-controller"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-controller"}},[s._v("#")]),s._v(" 6,controller:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8413.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_7-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-测试"}},[s._v("#")]),s._v(" 7,测试")]),s._v(" "),t("p",[s._v("启动 order 模块,访问 pay")]),s._v(" "),t("p",[s._v("再次压测 2 万并发,发现 order 访问也变慢了")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8414.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("解决:")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8415.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:""}},[t("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")]),s._v(" "),t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8416.png",alt:""}})]),s._v(" "),t("h4",{attrs:{id:"_3-配置服务降级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置服务降级"}},[s._v("#")]),s._v(" 3,配置服务降级:")]),s._v(" "),t("h5",{attrs:{id:"_1-修改-pay-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-修改-pay-模块"}},[s._v("#")]),s._v(" 1,修改 pay 模块")]),s._v(" "),t("h6",{attrs:{id:"_1-为-service-的指定方法-会延迟的方法-添加-hystrixcommand-注解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-为-service-的指定方法-会延迟的方法-添加-hystrixcommand-注解"}},[s._v("#")]),s._v(" 1,为 service 的指定方法(会延迟的方法)添加@HystrixCommand 注解")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8417.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_2-主启动类上-添加激活-hystrix-的注解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-主启动类上-添加激活-hystrix-的注解"}},[s._v("#")]),s._v(" 2,主启动类上,添加激活 hystrix 的注解")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8418.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_3-触发异常"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-触发异常"}},[s._v("#")]),s._v(" 3,触发异常")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8419.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8420.png",alt:""}}),t("strong",[s._v("可以看到,也触发了降级")])]),s._v(" "),t("h5",{attrs:{id:"_2-修改-order-模块-进行服务降级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改-order-模块-进行服务降级"}},[s._v("#")]),s._v(" 2,修改 order 模块,进行服务降级")]),s._v(" "),t("p",[s._v("一般服务降级,都是放在客户端(order 模块),")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8421.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_1-修改配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-修改配置文件"}},[s._v("#")]),s._v(" 1,修改配置文件:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8422.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_2-主启动类添加直接-启用-hystrix"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-主启动类添加直接-启用-hystrix"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2,主启动类添加直接,启用 hystrix:")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8423.png",alt:""}})]),s._v(" "),t("p",[s._v("​")]),s._v(" "),t("h6",{attrs:{id:"_3-修改-controller-添加降级方法什么的"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-修改-controller-添加降级方法什么的"}},[s._v("#")]),s._v(" 3,修改 controller,添加降级方法什么的")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8424.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_4-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-测试"}},[s._v("#")]),s._v(" 4,测试")]),s._v(" "),t("p",[s._v("启动 pay 模块,order 模块,")]),s._v(" "),t("p",[t("strong",[s._v("注意:,这里 pay 模块和 order 模块都开启了服务降级")])]),s._v(" "),t("p",[s._v("但是 order 这里,设置了 1.5 秒就降级,所以访问时,一定会降级")]),s._v(" "),t("h5",{attrs:{id:"_4-重构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-重构"}},[s._v("#")]),s._v(" 4,重构:")]),s._v(" "),t("p",[t("strong",[s._v("上面出现的问题:")])]),s._v(" "),t("ol",[t("li",[s._v("降级方法与业务方法写在了一块,耦合度高")]),s._v(" "),t("li",[s._v("每个业务方法都写了一个降级方法,重复代码多")])]),s._v(" "),t("h5",{attrs:{id:"解决重复代码的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决重复代码的问题"}},[s._v("#")]),s._v(" "),t("strong",[s._v("解决重复代码的问题")]),s._v(":")]),s._v(" "),t("p",[t("strong",[s._v("配置一个全局的降级方法,所有方法都可以走这个降级方法,至于某些特殊创建,再单独创建方法")])]),s._v(" "),t("h6",{attrs:{id:"_1-创建一个全局方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建一个全局方法"}},[s._v("#")]),s._v(" 1,创建一个全局方法")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8426.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_2-使用注解指定其为全局降级方法-默认降级方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-使用注解指定其为全局降级方法-默认降级方法"}},[s._v("#")]),s._v(" 2,使用注解指定其为全局降级方法(默认降级方法)")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8427.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8425.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_3-业务方法使用默认降级方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-业务方法使用默认降级方法"}},[s._v("#")]),s._v(" 3,业务方法使用默认降级方法:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8428.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_4-测试-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-测试-2"}},[s._v("#")]),s._v(" 4,测试:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8429.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"解决代码耦合度的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决代码耦合度的问题"}},[s._v("#")]),s._v(" 解决代码耦合度的问题:")]),s._v(" "),t("p",[s._v("修改 order 模块,这里开始,pay 模块就不服务降级了,服务降级写在 order 模块即可")]),s._v(" "),t("h6",{attrs:{id:"_1-payservice-接口是远程调用-pay-模块的-我们这里创建一个类实现-service-接口-在实现类中统一处理异常"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-payservice-接口是远程调用-pay-模块的-我们这里创建一个类实现-service-接口-在实现类中统一处理异常"}},[s._v("#")]),s._v(" 1,Payservice 接口是远程调用 pay 模块的,我们这里创建一个类实现 service 接口,在实现类中统一处理异常")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8430.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_2-修改配置文件-添加"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改配置文件-添加"}},[s._v("#")]),s._v(" 2,修改配置文件:添加:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8431.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_3-让-payservice-的实现类生效"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-让-payservice-的实现类生效"}},[s._v("#")]),s._v(" 3,让 PayService 的实现类生效:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8432.png",alt:""}})]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("它的运行逻辑是"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n\t\t当请求过来"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("首先还是通过"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Feign")]),s._v("远程调用pay模块对应的方法\n    但是如果pay模块报错"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("调用失败"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("那么就会调用"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PayMentFalbackService")]),s._v("类的\n    当前同名的方法"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("作为降级方法\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h6",{attrs:{id:"_4-启动测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-启动测试"}},[s._v("#")]),s._v(" 4,启动测试")]),s._v(" "),t("p",[s._v("启动 order 和 pay 正常访问--ok")]),s._v(" "),t("p",[s._v("==此时将 pay 服务关闭,order 再次访问==")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8433.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到,并没有报 500 错误,而是降级访问==实现类==的同名方法")]),s._v(" "),t("p",[s._v("这样,即使服务器挂了,用户要不要一直等待,或者报错")]),s._v(" "),t("p",[s._v("问题:")]),s._v(" "),t("p",[t("strong",[s._v("这样虽然解决了代码耦合度问题,但是又出现了过多重复代码的问题,每个方法都有一个降级方法")])]),s._v(" "),t("h3",{attrs:{id:"使用服务熔断"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用服务熔断"}},[s._v("#")]),s._v(" 使用服务熔断:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8434.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("比如并发达到 1000,我们就拒绝其他用户访问,在有用户访问,就访问降级方法")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8435.png",alt:""}})]),s._v(" "),t("h4",{attrs:{id:"_1-修改前面的-pay-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-修改前面的-pay-模块"}},[s._v("#")]),s._v(" 1,修改前面的 pay 模块")]),s._v(" "),t("h5",{attrs:{id:"_1-修改-payservice-接口-添加服务熔断相关的方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-修改-payservice-接口-添加服务熔断相关的方法"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1,修改 Payservice 接口,添加服务熔断相关的方法:")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8437.png",alt:""}})]),s._v(" "),t("p",[s._v("这里属性整体意思是:\n10 秒之内(窗口,会移动),如果并发==超过==10 个,或者 10 个并发中,失败了 6 个,就开启熔断器\n"),t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8443.png",alt:"image-20200414152637247"}})]),s._v(" "),t("p",[s._v("IdUtil 是 Hutool 包下的类,这个 Hutool 就是整合了所有的常用方法,比如 UUID,反射,IO 流等工具方法什么的都整合了")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8436.png",alt:""}})]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("断路器的打开和关闭"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("是按照一下"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("步决定的\n  \t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("并发此时是否达到我们指定的阈值\n  \t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("错误百分比"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("比如我们配置了"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("那么如果并发请求中"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("次有"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("次是失败的"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("就开启断路器\n  \t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("上面的条件符合"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("断路器改变状态为"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("open")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("开启"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  \t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("这个服务的断路器开启"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("所有请求无法访问\n  \t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("在我们的时间窗口期"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("期间"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("尝试让一些请求通过"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("半开状态"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("如果请求还是失败"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("证明断路器还是开启状态"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("服务没有恢复\n  \t\t如果请求成功了"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("证明服务已经恢复"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("断路器状态变为close关闭状态\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h5",{attrs:{id:"_2-修改-controller"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改-controller"}},[s._v("#")]),s._v(" 2,修改 controller")]),s._v(" "),t("p",[s._v("添加一个测试方法;")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8439.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_3-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-测试"}},[s._v("#")]),s._v(" 3,测试:")]),s._v(" "),t("p",[s._v("启动 pay,order 模块")]),s._v(" "),t("p",[s._v("==多次访问,并且错误率超过 60%:==")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8440.png",alt:""}})]),s._v(" "),t("p",[s._v("此时服务熔断,此时即使访问正确的也会报错:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8441.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("但是,当过了几秒后,又恢复了")])]),s._v(" "),t("p",[s._v("因为在 10 秒窗口期内,它自己会尝试接收部分请求,发现服务可以正常调用,慢慢的当错误率低于 60%,取消熔断")]),s._v(" "),t("h3",{attrs:{id:"hystrix-所有可配置的属性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hystrix-所有可配置的属性"}},[s._v("#")]),s._v(" Hystrix 所有可配置的属性:")]),s._v(" "),t("p",[t("strong",[s._v("全部在这个方法中记录,以成员变量的形式记录,")])]),s._v(" "),t("p",[s._v("​ 以后需要什么属性,查看这个类即可")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8438.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8442.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("==当断路器开启后:==")])]),s._v(" "),t("p",[s._v("​ "),t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8444.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("==其他参数:==")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8445.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8446.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8447.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8448.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8449.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("熔断整体流程:")])]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("请求进来"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("首先查询缓存"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("如果缓存有"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("直接返回\n  \t如果缓存没有"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("查看断路器是否开启"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("如果开启的"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Hystrix")]),s._v("直接将请求转发到降级返回"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("然后返回\n  \t如果断路器是关闭的"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t\t\t判断线程池等资源是否已经满了"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("如果已经满了\n  \t\t\t\t\t也会走降级方法\n  \t\t\t如果资源没有满"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("判断我们使用的什么类型的"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Hystrix")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("决定调用构造方法还是run方法\n        然后处理请求\n        然后"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Hystrix")]),s._v("将本次请求的结果信息汇报给断路器"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("因为断路器此时可能是开启的\n          \t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("因为断路器开启也是可以接收请求的"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \t\t断路器收到信息"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("判断是否符合开启或关闭断路器的条件"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t\t\t如果本次请求处理失败"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("又会进入降级方法\n        如果处理成功"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("判断处理是否超时"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("如果超时了"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("也进入降级方法\n        最后"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("没有超时"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("则本次请求处理成功"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("将结果返回给controller\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h3",{attrs:{id:"hystrix-服务监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hystrix-服务监控"}},[s._v("#")]),s._v(" Hystrix 服务监控:")]),s._v(" "),t("h4",{attrs:{id:"hystrixdashboard"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hystrixdashboard"}},[s._v("#")]),s._v(" HystrixDashboard")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8451.png",alt:""}})]),s._v(" "),t("h4",{attrs:{id:"_2-使用-hystrixdashboard"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-使用-hystrixdashboard"}},[s._v("#")]),s._v(" 2,使用 HystrixDashboard:")]),s._v(" "),t("h5",{attrs:{id:"_1-创建项目"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建项目"}},[s._v("#")]),s._v(" 1,创建项目:")]),s._v(" "),t("p",[s._v("名字: cloud_hystrixdashboard_9001")]),s._v(" "),t("h5",{attrs:{id:"_2-pom-文件-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-pom-文件-2"}},[s._v("#")]),s._v(" 2,pom 文件")]),s._v(" "),t("h5",{attrs:{id:"_3-配置文件-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置文件-3"}},[s._v("#")]),s._v(" 3,配置文件")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8452.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_4-主启动类-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-主启动类-3"}},[s._v("#")]),s._v(" 4,主启动类")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8453.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_5-修改所有-pay-模块-8001-8002-8003"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-修改所有-pay-模块-8001-8002-8003"}},[s._v("#")]),s._v(" 5,修改所有 pay 模块(8001,8002,8003...)")]),s._v(" "),t("p",[t("strong",[s._v("他们都添加一个 pom 依赖:")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8454.png",alt:""}})]),s._v(" "),t("p",[s._v("之前的 pom 文件中都添加过了,==这个是 springboot 的监控组件==")]),s._v(" "),t("h5",{attrs:{id:"_6-启动-9001-即可"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-启动-9001-即可"}},[s._v("#")]),s._v(" 6,启动 9001 即可")]),s._v(" "),t("p",[s._v("​ 访问: "),t("strong",[s._v("localhost:9001/hystrix")])]),s._v(" "),t("h5",{attrs:{id:"_7-注意-此时仅仅是可以访问-hystrixdashboard-并不代表已经监控了-8001-8002"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-注意-此时仅仅是可以访问-hystrixdashboard-并不代表已经监控了-8001-8002"}},[s._v("#")]),s._v(" 7,注意,此时仅仅是可以访问 HystrixDashboard,并不代表已经监控了 8001,8002")]),s._v(" "),t("p",[s._v("如果要监控,还需要配置:(8001 为例)")]),s._v(" "),t("p",[s._v("==8001 的主启动类添加:==")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8455.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("其他 8002,8003 都是一样的")])]),s._v(" "),t("h5",{attrs:{id:"_8-到此-可以启动服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-到此-可以启动服务"}},[s._v("#")]),s._v(" 8,到此,可以启动服务")]),s._v(" "),t("p",[s._v("启动 7001,8001,9001")]),s._v(" "),t("p",[t("strong",[s._v("然后在 web 界面,指定 9001 要监控 8001:")])]),s._v(" "),t("h5",{attrs:{id:"-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#-2"}},[s._v("#")]),s._v(" "),t("img",{attrs:{src:"https://fltrp-dera.oss-cn-hangzhou.aliyuncs.com/spring-cloud/pic/Hystrix%E7%9A%8456.png",alt:""}})])])}),[],!1,null,null,null);t.default=n.exports}}]);